<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCISM Internship Certificate Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .main-content {
            padding: 40px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            background: transparent;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: #495057;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #06d6a0;
            color: white;
        }

        .btn-success:hover {
            background: #05c195;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .csv-upload {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            margin: 20px 0;
        }

        .csv-upload.dragover {
            background: #e6f2ff;
            border-color: #4c63d2;
        }

        .students-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
        }

        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }

        .student-info {
            flex: 1;
        }

        .student-name {
            font-weight: 600;
            color: #2d3748;
        }

        .student-details {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .certificate-preview {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .cert-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .cert-title {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .cert-content {
            padding: 40px;
            line-height: 1.8;
        }

        .ncism-badge {
            background: linear-gradient(135deg, #06d6a0 0%, #118ab2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
            font-weight: 600;
        }

        .student-name-display {
            font-size: 1.8rem;
            font-weight: 600;
            color: #2d3748;
            text-align: center;
            margin: 25px 0;
            padding: 15px;
            border: 3px double #667eea;
            border-radius: 10px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 25px 0;
        }

        .detail-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .detail-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .detail-value {
            color: #2d3748;
            font-weight: 500;
        }

        .signatures {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 50px;
            margin-top: 40px;
            text-align: center;
        }

        .signature-block {
            padding-top: 40px;
        }

        .signature-line {
            border-top: 2px solid #667eea;
            margin-bottom: 8px;
        }

        .signature-title {
            font-weight: 600;
            color: #495057;
        }

        .actions {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
            flex-wrap: wrap;
        }

        .hidden {
            display: none;
        }

        .sample-csv {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .batch-actions {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        @media print {
            body {
                background: white !important;
            }
            .admin-container {
                box-shadow: none !important;
            }
            .main-content, .tabs, .actions {
                display: none !important;
            }
            .certificate-preview {
                box-shadow: none !important;
                max-width: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="header">
            <h1>📜 NCISM Certificate Generator</h1>
            <p>Generate Internship Completion Certificates for BAMS Students</p>
        </div>

        <div class="main-content">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('single')">Single Certificate</button>
                <button class="tab" onclick="switchTab('departmental')">Departmental Rotation</button>
                <button class="tab" onclick="switchTab('bulk')">Bulk Upload</button>
                <button class="tab" onclick="switchTab('manage')">Manage Students</button>
            </div>

            <!-- Single Certificate Tab -->
            <div id="single-tab" class="tab-content active">
                <h2>Generate Single Certificate</h2>
                <form id="single-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="studentName">Student Name *</label>
                            <input type="text" id="studentName" required>
                        </div>
                        <div class="form-group">
                            <label for="registrationNo">Registration Number *</label>
                            <input type="text" id="registrationNo" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="rollNumber">University Roll Number *</label>
                            <input type="text" id="rollNumber" required>
                        </div>
                        <div class="form-group">
                            <label for="academicYear">Academic Year *</label>
                            <input type="text" id="academicYear" placeholder="e.g., 2024-25" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="startDate">Internship Start Date *</label>
                            <input type="date" id="startDate" required>
                        </div>
                        <div class="form-group">
                            <label for="endDate">Internship End Date *</label>
                            <input type="date" id="endDate" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="issueDate">Certificate Issue Date *</label>
                            <input type="date" id="issueDate" required>
                        </div>
                        <div class="form-group">
                            <label for="certNumber">Certificate Number *</label>
                            <input type="text" id="certNumber" placeholder="JAGMAMCH/001/2025" readonly>
                            <button type="button" class="btn btn-secondary" onclick="generateCertNumber()" style="margin-top: 5px;">Auto Generate</button>
                        </div>
                    </div>
                    <div class="actions">
                        <button type="button" class="btn btn-primary" onclick="generatePreview()">Generate Preview</button>
                        <button type="button" class="btn btn-success" onclick="printCertificate()">Print Certificate</button>
                        <button type="button" class="btn btn-secondary" onclick="downloadPDF()">Download PDF</button>
                        <button type="button" class="btn btn-secondary" onclick="downloadWord()">Download Word</button>
                        <button type="button" class="btn" onclick="copyToRotationTab()" style="background: #17a2b8; color: white;">→ Create Rotation Certificate</button>
                    </div>
                </form>
            </div>

            <!-- Departmental Rotation Certificate Tab -->
            <div id="departmental-tab" class="tab-content">
                <h2>Departmental Rotation Certificate</h2>
                <form id="departmental-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="deptStudentName">Student Name *</label>
                            <input type="text" id="deptStudentName" required>
                        </div>
                        <div class="form-group">
                            <label for="deptRegistrationNo">Registration Number *</label>
                            <input type="text" id="deptRegistrationNo" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="deptAcademicYear">Academic Year *</label>
                            <input type="text" id="deptAcademicYear" placeholder="e.g., 2024-25" required>
                        </div>
                        <div class="form-group">
                            <label for="deptCertNumber">Certificate Number *</label>
                            <input type="text" id="deptCertNumber" placeholder="JAGMAMCH/001/2025" readonly>
                            <button type="button" class="btn btn-secondary" onclick="generateDeptCertNumber()" style="margin-top: 5px;">Auto Generate</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="deptIssueDate">Certificate Issue Date *</label>
                        <input type="date" id="deptIssueDate" required>
                    </div>
                    
                    <h3 style="margin: 30px 0 20px; color: #667eea;">Department Rotations</h3>
                    <div id="departmentRotations">
                        <!-- Department rotation fields will be dynamically generated -->
                    </div>
                    
                    <div class="actions">
                        <button type="button" class="btn btn-primary" onclick="generateDepartmentalPreview()">Generate Preview</button>
                        <button type="button" class="btn btn-success" onclick="printDepartmentalCertificate()">Print Certificate</button>
                        <button type="button" class="btn btn-secondary" onclick="downloadDepartmentalPDF()">Download PDF</button>
                        <button type="button" class="btn btn-secondary" onclick="downloadDepartmentalWord()">Download Word</button>
                        <button type="button" class="btn" onclick="copyToMainTab()" style="background: #17a2b8; color: white;">← Create Main Certificate</button>
                    </div>
                </form>
            </div>

            <!-- Bulk Upload Tab -->
            <div id="bulk-tab" class="tab-content">
                <h2>Bulk Certificate Generation</h2>
                <div class="csv-upload" id="csvUpload">
                    <h3>📄 Upload Student Data CSV</h3>
                    <p>Drag & drop your CSV file here or click to browse</p>
                    <input type="file" id="csvFile" accept=".csv" style="display: none;">
                    <button type="button" class="btn btn-primary" onclick="document.getElementById('csvFile').click()">Choose File</button>
                </div>
                
                <div class="sample-csv">
                    <strong>CSV Format Example:</strong><br>
                    StudentName,RegistrationNo,AcademicYear,StartDate,EndDate,IssueDate,CertNumber<br>
                    John Doe,REG001,2024-25,2024-01-15,2025-01-14,2025-02-01,JAGMAMCH/001/2025<br>
                    Jane Smith,REG002,2024-25,2024-01-15,2025-01-14,2025-02-01,JAGMAMCH/002/2025
                </div>

                <div class="progress-bar hidden" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>

                <div class="batch-actions hidden" id="batchActions">
                    <button class="btn btn-success" onclick="generateAllCertificates()">Generate All Certificates</button>
                    <button class="btn btn-primary" onclick="downloadCSVTemplate()">Download CSV Template</button>
                    <button class="btn btn-secondary" onclick="downloadAllPDFs()">Download All PDFs</button>
                    <button class="btn btn-secondary" onclick="downloadAllWord()">Download All Word Docs</button>
                    <button class="btn btn-primary" onclick="autoNumberAll()">Auto Number All</button>
                    <span id="uploadStatus"></span>
                </div>
            </div>

            <!-- Manage Students Tab -->
            <div id="manage-tab" class="tab-content">
                <h2>Manage Student Records</h2>
                <div class="students-list" id="studentsList">
                    <p style="text-align: center; color: #6c757d;">No students loaded. Use bulk upload to add student records.</p>
                </div>
                <div class="actions">
                    <button class="btn btn-secondary" onclick="clearAllStudents()">Clear All Records</button>
                    <button class="btn btn-primary" onclick="exportStudentData()">Export Data</button>
                </div>
            </div>

            <!-- Certificate Preview -->
            <div id="certificatePreview" class="hidden" style="margin-top: 30px;">
                <h2 style="text-align: center; margin-bottom: 20px;">Certificate Preview</h2>
                <div class="certificate-preview">
                    <div class="cert-header">
                        <div class="cert-title">Internship Completion Certificate</div>
                    </div>
                    <div class="cert-content">
                        <div class="ncism-badge">
                            ✓ NCISM Compliant • 12-Month Compulsory Rotatory Internship • BAMS Program<br>
                            <small>NCISM College Code: AYU0484 | RGUHS College Code: A456</small>
                        </div>
                        
                        <p style="text-align: center; margin: 20px 0;">This is to certify that</p>
                        
                        <div class="student-name-display" id="previewStudentName">[Student Name]</div>
                        
                        <p style="text-align: center; margin: 20px 0;">
                            has successfully completed the mandatory <strong>12-month Compulsory Rotatory Internship</strong> 
                            as required under the regulations of the National Commission for Indian System of Medicine (NCISM) 
                            for the Bachelor of Ayurvedic Medicine and Surgery (BAMS) degree program.
                        </p>
                        
                        <div class="details-grid">
                            <div class="detail-item">
                                <div class="detail-label">Registration Number</div>
                                <div class="detail-value" id="previewRegNo">[Registration No.]</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Internship Start Date</div>
                                <div class="detail-value" id="previewStartDate">[Start Date]</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Internship Completion Date</div>
                                <div class="detail-value" id="previewEndDate">[End Date]</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Duration</div>
                                <div class="detail-value">12 Months (365 Days)</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Academic Year</div>
                                <div class="detail-value" id="previewAcademicYear">[Academic Year]</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">NCISM College Code</div>
                                <div class="detail-value">AYU0484</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">RGUHS College Code</div>
                                <div class="detail-value">A456</div>
                            </div>
                        </div>
                        
                        <p style="margin: 25px 0;">
                            The internship was conducted in accordance with the NCISM regulations and included rotations in 
                            various departments of Ayurveda including Kayachikitsa, Panchakarma, Shalya Tantra, 
                            Shalakya Tantra, Prasuti Tantra & Stree Rog, and Kaumarbhritya, along with community health settings 
                            as mandated by the curriculum.
                        </p>
                        
                        <p style="margin: 25px 0;">
                            The candidate has demonstrated satisfactory performance and clinical competency during the internship period 
                            and is eligible for registration with the respective State Medical Council/Board.
                        </p>

                        <p style="margin: 25px 0;">
                            <strong>Date of Issue:</strong> <span id="previewIssueDate">[Issue Date]</span><br>
                            <strong>Place:</strong> Varur<br>
                            <strong>Certificate No:</strong> <span id="previewCertNumber">[Certificate Number]</span>
                        </p>
                        
                        <div class="signatures">
                            <div class="signature-block">
                                <div class="signature-line"></div>
                                <div class="signature-title">Medical Superintendent</div>
                            </div>
                            <div class="signature-block">
                                <div class="signature-line"></div>
                                <div class="signature-title">Dean/Principal</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Departmental Rotation Preview -->
            <div id="departmentalPreview" class="hidden" style="margin-top: 30px;">
                <h2 style="text-align: center; margin-bottom: 20px;">Departmental Rotation Certificate Preview</h2>
                <div class="certificate-preview">
                    <div class="cert-header">
                        <div class="cert-title">Departmental Rotation Certificate</div>
                    </div>
                    <div class="cert-content">
                        <div class="ncism-badge">
                            ✓ NCISM Compliant • Departmental Rotation Record • BAMS Internship Program<br>
                            <small>NCISM College Code: AYU0484 | RGUHS College Code: A456</small>
                        </div>
                        
                        <p style="text-align: center; margin: 20px 0;">This is to certify that</p>
                        
                        <div class="student-name-display" id="deptPreviewStudentName">[Student Name]</div>
                        
                        <p style="text-align: center; margin: 20px 0;">
                            has successfully completed departmental rotations as part of the mandatory 
                            <strong>12-month Compulsory Rotatory Internship</strong> in accordance with the regulations 
                            of the National Commission for Indian System of Medicine (NCISM) for the Bachelor of 
                            Ayurvedic Medicine and Surgery (BAMS) degree program.
                        </p>
                        
                        <div style="margin: 30px 0;">
                            <div class="detail-item" style="margin-bottom: 15px;">
                                <div class="detail-label">Registration Number</div>
                                <div class="detail-value" id="deptPreviewRegNo">[Registration No.]</div>
                            </div>
                            <div class="detail-item" style="margin-bottom: 15px;">
                                <div class="detail-label">Academic Year</div>
                                <div class="detail-value" id="deptPreviewAcademicYear">[Academic Year]</div>
                            </div>
                        </div>
                        
                        <h3 style="color: #667eea; margin: 25px 0 15px;">Department-wise Rotation Details:</h3>
                        <div id="rotationDetails" style="margin: 20px 0;">
                            <!-- Rotation details will be populated here -->
                        </div>
                        
                        <p style="margin: 25px 0;">
                            The above departmental rotations were completed under proper supervision and guidance, 
                            ensuring comprehensive clinical exposure and practical training in various specialties 
                            of Ayurveda as mandated by the NCISM curriculum.
                        </p>

                        <p style="margin: 25px 0;">
                            <strong>Date of Issue:</strong> <span id="deptPreviewIssueDate">[Issue Date]</span><br>
                            <strong>Place:</strong> Varur<br>
                            <strong>Certificate No:</strong> <span id="deptPreviewCertNumber">[Certificate Number]</span>
                        </p>
                        
                        <div class="signatures">
                            <div class="signature-block">
                                <div class="signature-line"></div>
                                <div class="signature-title">Medical Superintendent</div>
                            </div>
                            <div class="signature-block">
                                <div class="signature-line"></div>
                                <div class="signature-title">Dean/Principal</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        let studentsData = [];
        let certificateCounter = 1;
        
        // Department list
        const departments = [
            'KAYACHIKITSA',
            'PANCHAKARMA', 
            'SHALYA TANTRA',
            'SHALAKYA TANTRA',
            'PRASUTI TANTRA & STREE ROGA',
            'KAUMARABHRITYA',
            'SWASTHAVRITTA',
            'ATYAYIKA',
            'SCREENING',
            'LABORATORY',
            'PHARMACY',
            'AYUSH POSTING',
            'CANCER HOSPITAL',
            'PHYSIOTHERAPY CENTER',
            'AGARWAL\'S EYE HOSPITAL',
            'SPARSH PEDIATRIC HOSPITAL'
        ];

        // Auto Certificate Numbering Functions
        function generateCertNumber() {
            const currentYear = new Date().getFullYear();
            const certNumber = `JAGMAMCH/${String(certificateCounter).padStart(3, '0')}/${currentYear}`;
            document.getElementById('certNumber').value = certNumber;
            certificateCounter++;
            localStorage.setItem('certificateCounter', certificateCounter);
        }

        function generateDeptCertNumber() {
            const currentYear = new Date().getFullYear();
            const certNumber = `JAGMAMCH/DEPT/${String(certificateCounter).padStart(3, '0')}/${currentYear}`;
            document.getElementById('deptCertNumber').value = certNumber;
            certificateCounter++;
            localStorage.setItem('certificateCounter', certificateCounter);
        }

        function autoNumberAll() {
            if (studentsData.length === 0) {
                alert('No student data available');
                return;
            }
            
            const currentYear = new Date().getFullYear();
            studentsData.forEach((student, index) => {
                student.CertNumber = `JAGMAMCH/${String(certificateCounter + index).padStart(3, '0')}/${currentYear}`;
            });
            
            certificateCounter += studentsData.length;
            localStorage.setItem('certificateCounter', certificateCounter);
            updateStudentsList();
            saveData();
            alert(`Auto-numbered ${studentsData.length} certificates!`);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set default issue date to today
            document.getElementById('issueDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('deptIssueDate').value = new Date().toISOString().split('T')[0];
            
            // Load saved data first
            loadSavedData();
            
            // Generate initial certificate numbers
            generateCertNumber();
            generateDeptCertNumber();
            
            // Setup CSV upload
            setupCSVUpload();
            
            // Generate department rotation fields
            generateDepartmentFields();
        });

        function loadSavedData() {
            const saved = localStorage.getItem('certificateStudents');
            if (saved) {
                studentsData = JSON.parse(saved);
                updateStudentsList();
                if (studentsData.length > 0) {
                    updateUploadStatus();
                }
            }
            
            // Load certificate counter
            const savedCounter = localStorage.getItem('certificateCounter');
            if (savedCounter) {
                certificateCounter = parseInt(savedCounter);
            }
        }

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        function setupCSVUpload() {
            const uploadArea = document.getElementById('csvUpload');
            const fileInput = document.getElementById('csvFile');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    processCSV(files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    processCSV(e.target.files[0]);
                }
            });
        }

        function processCSV(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                const lines = csv.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                
                studentsData = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = lines[i].split(',').map(v => v.trim());
                        const student = {};
                        headers.forEach((header, index) => {
                            student[header] = values[index] || '';
                        });
                        studentsData.push(student);
                    }
                }
                
                updateUploadStatus();
                updateStudentsList();
                saveData();
            };
            reader.readAsText(file);
        }

        function updateUploadStatus() {
            const status = document.getElementById('uploadStatus');
            const actions = document.getElementById('batchActions');
            
            status.textContent = `✅ ${studentsData.length} students loaded`;
            actions.classList.remove('hidden');
        }

        function updateStudentsList() {
            const container = document.getElementById('studentsList');
            
            if (studentsData.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d;">No students loaded. Use bulk upload to add student records.</p>';
                return;
            }
            
            container.innerHTML = studentsData.map((student, index) => `
                <div class="student-item">
                    <div class="student-info">
                        <div class="student-name">${student.StudentName}</div>
                        <div class="student-details">Reg: ${student.RegistrationNo} | ${student.AcademicYear}</div>
                    </div>
                    <div>
                        <button class="btn btn-primary" onclick="generateSingleFromData(${index})">Generate Main</button>
                        <button class="btn" onclick="generateRotationFromData(${index})" style="background: #17a2b8; color: white;">Generate Rotation</button>
                        <button class="btn btn-secondary" onclick="downloadSinglePDF(${index})">PDF</button>
                        <button class="btn btn-secondary" onclick="downloadSingleWord(${index})">Word</button>
                        <button class="btn btn-secondary" onclick="removeStudent(${index})">Remove</button>
                    </div>
                </div>
            `).join('');
        }

        function generatePreview() {
            const form = document.getElementById('single-form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const data = {
                StudentName: document.getElementById('studentName').value,
                RegistrationNo: document.getElementById('registrationNo').value,
                AcademicYear: document.getElementById('academicYear').value,
                StartDate: formatDate(document.getElementById('startDate').value),
                EndDate: formatDate(document.getElementById('endDate').value),
                IssueDate: formatDate(document.getElementById('issueDate').value),
                CertNumber: document.getElementById('certNumber').value
            };
            
            populatePreview(data);
            document.getElementById('certificatePreview').classList.remove('hidden');
            document.getElementById('certificatePreview').scrollIntoView({behavior: 'smooth'});
        }

        function populatePreview(data) {
            document.getElementById('previewStudentName').textContent = data.StudentName;
            document.getElementById('previewRegNo').textContent = data.RegistrationNo;
            document.getElementById('previewStartDate').textContent = data.StartDate;
            document.getElementById('previewEndDate').textContent = data.EndDate;
            document.getElementById('previewAcademicYear').textContent = data.AcademicYear;
            document.getElementById('previewIssueDate').textContent = data.IssueDate;
            document.getElementById('previewCertNumber').textContent = data.CertNumber;
        }

        function generateDepartmentFields() {
            const container = document.getElementById('departmentRotations');
            container.innerHTML = departments.map(dept => `
                <div class="form-row" style="align-items: end; margin-bottom: 15px; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; background: #f8f9fa;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label><strong>${dept}</strong></label>
                        <div style="display: flex; gap: 10px; margin-top: 8px;">
                            <div style="flex: 1;">
                                <label style="font-size: 0.85rem; margin-bottom: 5px;">From Date</label>
                                <input type="date" id="${dept.replace(/[^A-Z0-9]/g, '_')}_from" style="padding: 8px;">
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 0.85rem; margin-bottom: 5px;">To Date</label>
                                <input type="date" id="${dept.replace(/[^A-Z0-9]/g, '_')}_to" style="padding: 8px;">
                            </div>
                            <div style="flex: 0.8;">
                                <label style="font-size: 0.85rem; margin-bottom: 5px;">Days</label>
                                <input type="number" id="${dept.replace(/[^A-Z0-9]/g, '_')}_days" placeholder="Days" style="padding: 8px;" readonly>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Add event listeners to calculate days automatically
            departments.forEach(dept => {
                const deptId = dept.replace(/[^A-Z0-9]/g, '_');
                const fromInput = document.getElementById(`${deptId}_from`);
                const toInput = document.getElementById(`${deptId}_to`);
                const daysInput = document.getElementById(`${deptId}_days`);
                
                function calculateDays() {
                    if (fromInput.value && toInput.value) {
                        const from = new Date(fromInput.value);
                        const to = new Date(toInput.value);
                        const timeDiff = to.getTime() - from.getTime();
                        const dayDiff = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1;
                        daysInput.value = dayDiff > 0 ? dayDiff : '';
                    } else {
                        daysInput.value = '';
                    }
                }
                
                fromInput.addEventListener('change', calculateDays);
                toInput.addEventListener('change', calculateDays);
            });
        }

        // Departmental Certificate Functions
        function generateDepartmentalPreview() {
            const form = document.getElementById('departmental-form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const data = {
                StudentName: document.getElementById('deptStudentName').value,
                RegistrationNo: document.getElementById('deptRegistrationNo').value,
                AcademicYear: document.getElementById('deptAcademicYear').value,
                IssueDate: formatDate(document.getElementById('deptIssueDate').value),
                CertNumber: document.getElementById('deptCertNumber').value
            };
            
            // Collect department rotation data
            const rotations = [];
            departments.forEach(dept => {
                const deptId = dept.replace(/[^A-Z0-9]/g, '_');
                const fromDate = document.getElementById(`${deptId}_from`).value;
                const toDate = document.getElementById(`${deptId}_to`).value;
                const days = document.getElementById(`${deptId}_days`).value;
                
                if (fromDate && toDate && days) {
                    rotations.push({
                        department: dept,
                        from: formatDate(fromDate),
                        to: formatDate(toDate),
                        days: days
                    });
                }
            });
            
            data.rotations = rotations;
            populateDepartmentalPreview(data);
            document.getElementById('departmentalPreview').classList.remove('hidden');
            document.getElementById('departmentalPreview').scrollIntoView({behavior: 'smooth'});
        }

        // Cross-tab data copying functions
        function copyToRotationTab() {
            const studentName = document.getElementById('studentName').value;
            const registrationNo = document.getElementById('registrationNo').value;
            const academicYear = document.getElementById('academicYear').value;
            
            if (!studentName || !registrationNo) {
                alert('Please fill in student name and registration number first');
                return;
            }
            
            // Switch to departmental tab
            switchTab('departmental');
            
            // Fill in the data
            document.getElementById('deptStudentName').value = studentName;
            document.getElementById('deptRegistrationNo').value = registrationNo;
            document.getElementById('deptAcademicYear').value = academicYear;
            
            // Generate certificate number if not already done
            if (!document.getElementById('deptCertNumber').value) {
                generateDeptCertNumber();
            }
            
            alert('✅ Student data copied! Now fill in the department rotation details.');
        }

        function copyToMainTab() {
            const studentName = document.getElementById('deptStudentName').value;
            const registrationNo = document.getElementById('deptRegistrationNo').value;
            const academicYear = document.getElementById('deptAcademicYear').value;
            
            if (!studentName || !registrationNo) {
                alert('Please fill in student name and registration number first');
                return;
            }
            
            // Switch to single tab
            switchTab('single');
            
            // Fill in the data
            document.getElementById('studentName').value = studentName;
            document.getElementById('registrationNo').value = registrationNo;
            document.getElementById('academicYear').value = academicYear;
            
            alert('✅ Student data copied! Now fill in the internship start/end dates.');
        }

        function generateRotationFromData(index) {
            const student = studentsData[index];
            
            // Switch to departmental tab
            switchTab('departmental');
            
            // Fill in the data
            document.getElementById('deptStudentName').value = student.StudentName;
            document.getElementById('deptRegistrationNo').value = student.RegistrationNo;
            document.getElementById('deptAcademicYear').value = student.AcademicYear;
            
            // Generate certificate number
            generateDeptCertNumber();
            
            alert(`✅ ${student.StudentName}'s data loaded for rotation certificate! Fill in department rotation details and generate.`);
        }

        function populateDepartmentalPreview(data) {
            document.getElementById('deptPreviewStudentName').textContent = data.StudentName;
            document.getElementById('deptPreviewRegNo').textContent = data.RegistrationNo;
            document.getElementById('deptPreviewAcademicYear').textContent = data.AcademicYear;
            document.getElementById('deptPreviewIssueDate').textContent = data.IssueDate;
            document.getElementById('deptPreviewCertNumber').textContent = data.CertNumber;
            
            // Populate rotation details
            const rotationContainer = document.getElementById('rotationDetails');
            if (data.rotations.length === 0) {
                rotationContainer.innerHTML = '<p style="color: #6c757d; font-style: italic;">No department rotations entered.</p>';
            } else {
                rotationContainer.innerHTML = data.rotations.map(rotation => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; margin: 8px 0; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #667eea;">
                        <div style="flex: 2; font-weight: 600; color: #495057;">${rotation.department}</div>
                        <div style="flex: 1; text-align: center; color: #6c757d;">${rotation.from} to ${rotation.to}</div>
                        <div style="flex: 0.5; text-align: center; font-weight: 600; color: #667eea;">${rotation.days} days</div>
                    </div>
                `).join('');
            }
        }

        function printDepartmentalCertificate() {
            if (document.getElementById('departmentalPreview').classList.contains('hidden')) {
                alert('Please generate a preview first');
                return;
            }
            window.print();
        }

        function downloadDepartmentalPDF() {
            if (document.getElementById('departmentalPreview').classList.contains('hidden')) {
                alert('Please generate a preview first');
                return;
            }
            
            const studentName = document.getElementById('deptPreviewStudentName').textContent;
            const element = document.querySelector('#departmentalPreview .certificate-preview');
            const opt = {
                margin: 0.5,
                filename: `${studentName}_Departmental_Rotation_Certificate.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save();
        }

        function downloadDepartmentalWord() {
            if (document.getElementById('departmentalPreview').classList.contains('hidden')) {
                alert('Please generate a preview first');
                return;
            }
            
            const studentName = document.getElementById('deptPreviewStudentName').textContent;
            const content = generateDepartmentalWordContent();
            
            // Create proper Word document blob
            const blob = new Blob(['\ufeff', content], {
                type: 'application/msword'
            });
            
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${studentName}_Departmental_Rotation_Certificate.doc`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function generateDepartmentalWordContent() {
            const studentName = document.getElementById('deptPreviewStudentName').textContent;
            const regNo = document.getElementById('deptPreviewRegNo').textContent;
            const academicYear = document.getElementById('deptPreviewAcademicYear').textContent;
            const issueDate = document.getElementById('deptPreviewIssueDate').textContent;
            const certNumber = document.getElementById('deptPreviewCertNumber').textContent;
            
            // Get rotation details in plain text
            const rotationContainer = document.getElementById('rotationDetails');
            let rotationsText = '';
            
            // Get the actual rotation data from the preview
            const rotationElements = rotationContainer.querySelectorAll('div[style*="display: flex"]');
            rotationElements.forEach(element => {
                const deptName = element.querySelector('div:first-child').textContent;
                const dates = element.querySelector('div:nth-child(2)').textContent;
                const days = element.querySelector('div:last-child').textContent;
                rotationsText += `• ${deptName}: ${dates} (${days})\n`;
            });
            
            if (!rotationsText) {
                rotationsText = '• No department rotations entered.\n';
            }
            
            return `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">
<head>
<meta charset="utf-8">
<title>Departmental Rotation Certificate</title>
<style>
body { 
    font-family: 'Times New Roman', serif; 
    font-size: 12pt; 
    line-height: 1.6; 
    margin: 1in;
    color: black;
}
.center { text-align: center; }
.bold { font-weight: bold; }
.title { 
    font-size: 16pt; 
    font-weight: bold; 
    text-transform: uppercase; 
    text-align: center;
    margin: 20pt 0; 
}
.student-name { 
    font-size: 14pt; 
    font-weight: bold; 
    text-align: center;
    margin: 15pt 0; 
    text-decoration: underline;
}
.details { margin: 15pt 0; }
.detail-item { margin: 5pt 0; }
.compliance { 
    text-align: center; 
    margin: 15pt 0; 
    font-weight: bold;
}
.rotation-section { margin: 20pt 0; }
.rotation-title { 
    font-weight: bold; 
    margin: 15pt 0 10pt 0; 
}
.rotation-list { margin: 10pt 0; }
.signatures { 
    margin-top: 50pt; 
    text-align: center;
}
.signature-line { 
    display: inline-block;
    width: 200pt; 
    border-bottom: 1pt solid black; 
    margin: 30pt 50pt 5pt 50pt; 
}
.signature-title {
    display: inline-block;
    margin: 0 50pt;
    font-weight: bold;
}
</style>
</head>
<body>
<div class="title">DEPARTMENTAL ROTATION CERTIFICATE</div>

<div class="compliance">✓ NCISM Compliant • Departmental Rotation Record • BAMS Internship Program<br>
NCISM College Code: AYU0484 | RGUHS College Code: A456</div>

<div class="center">
<p>This is to certify that</p>

<div class="student-name">${studentName}</div>

<p>has successfully completed departmental rotations as part of the mandatory <span class="bold">12-month Compulsory Rotatory Internship</span> in accordance with the regulations of the National Commission for Indian System of Medicine (NCISM) for the Bachelor of Ayurvedic Medicine and Surgery (BAMS) degree program.</p>
</div>

<div class="details">
<p class="bold">STUDENT DETAILS:</p>
<div class="detail-item">• Registration Number: ${regNo}</div>
<div class="detail-item">• Academic Year: ${academicYear}</div>
<div class="detail-item">• NCISM College Code: AYU0484</div>
<div class="detail-item">• RGUHS College Code: A456</div>
</div>

<div class="rotation-section">
<p class="rotation-title">DEPARTMENT-WISE ROTATION DETAILS:</p>
<div class="rotation-list">
${rotationsText.split('\n').filter(line => line.trim()).map(line => `<div class="detail-item">${line}</div>`).join('')}
</div>
</div>

<p>The above departmental rotations were completed under proper supervision and guidance, ensuring comprehensive clinical exposure and practical training in various specialties of Ayurveda as mandated by the NCISM curriculum.</p>

<p><span class="bold">Date of Issue:</span> ${issueDate} &nbsp;&nbsp;&nbsp; <span class="bold">Place:</span> Varur &nbsp;&nbsp;&nbsp; <span class="bold">Certificate No:</span> ${certNumber}</p>

<div class="signatures">
<div>
<div class="signature-line"></div>
<div class="signature-line"></div>
</div>
<div>
<span class="signature-title">Medical Superintendent</span>
<span class="signature-title">Dean/Principal</span>
</div>
</div>

</body>
</html>`;
        }

        function printCertificate() {
            if (document.getElementById('certificatePreview').classList.contains('hidden')) {
                alert('Please generate a preview first');
                return;
            }
            window.print();
        }

        function generateSingleFromData(index) {
            const student = studentsData[index];
            populatePreview({
                StudentName: student.StudentName,
                RegistrationNo: student.RegistrationNo,
                AcademicYear: student.AcademicYear,
                StartDate: formatDate(student.StartDate),
                EndDate: formatDate(student.EndDate),
                IssueDate: formatDate(student.IssueDate),
                CertNumber: student.CertNumber
            });
            
            document.getElementById('certificatePreview').classList.remove('hidden');
            document.getElementById('certificatePreview').scrollIntoView({behavior: 'smooth'});
        }

        function generateAllCertificates() {
            if (studentsData.length === 0) {
                alert('No student data available');
                return;
            }
            
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            progressBar.classList.remove('hidden');
            
            let processed = 0;
            studentsData.forEach((student, index) => {
                setTimeout(() => {
                    populatePreview({
                        StudentName: student.StudentName,
                        RegistrationNo: student.RegistrationNo,
                        AcademicYear: student.AcademicYear,
                        StartDate: formatDate(student.StartDate),
                        EndDate: formatDate(student.EndDate),
                        IssueDate: formatDate(student.IssueDate),
                        CertNumber: student.CertNumber
                    });
                    
                    document.getElementById('certificatePreview').classList.remove('hidden');
                    
                    processed++;
                    const progress = (processed / studentsData.length) * 100;
                    progressFill.style.width = progress + '%';
                    
                    if (processed === studentsData.length) {
                        alert('All certificates generated! Use Print Certificate button for each one.');
                        progressBar.classList.add('hidden');
                    }
                }, index * 500);
            });
        }

        function removeStudent(index) {
            studentsData.splice(index, 1);
            updateStudentsList();
            saveData();
        }

        function clearAllStudents() {
            if (confirm('Are you sure you want to clear all student records?')) {
                studentsData = [];
                updateStudentsList();
                saveData();
                document.getElementById('batchActions').classList.add('hidden');
            }
        }

        function downloadCSVTemplate() {
            const csvContent = `StudentName,RegistrationNo,AcademicYear,StartDate,EndDate,IssueDate,CertNumber
John Doe,REG001,2024-25,2024-01-15,2025-01-14,2025-02-01,JAGMAMCH/001/2025
Jane Smith,REG002,2024-25,2024-01-15,2025-01-14,2025-02-01,JAGMAMCH/002/2025`;
            
            downloadFile(csvContent, 'certificate_template.csv', 'text/csv');
        }

        function exportStudentData() {
            if (studentsData.length === 0) {
                alert('No data to export');
                return;
            }
            
            const headers = Object.keys(studentsData[0]);
            const csvContent = [
                headers.join(','),
                ...studentsData.map(student => headers.map(header => student[header]).join(','))
            ].join('\n');
            
            downloadFile(csvContent, 'student_records.csv', 'text/csv');
        }

        // Download Functions
        function downloadPDF() {
            if (document.getElementById('certificatePreview').classList.contains('hidden')) {
                alert('Please generate a preview first');
                return;
            }
            
            const studentName = document.getElementById('previewStudentName').textContent;
            const element = document.querySelector('.certificate-preview');
            const opt = {
                margin: 0.5,
                filename: `${studentName}_Internship_Certificate.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save();
        }

        function downloadWord() {
            if (document.getElementById('certificatePreview').classList.contains('hidden')) {
                alert('Please generate a preview first');
                return;
            }
            
            const studentName = document.getElementById('previewStudentName').textContent;
            const content = generateWordContent();
            
            // Create proper Word document blob
            const blob = new Blob(['\ufeff', content], {
                type: 'application/msword'
            });
            
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${studentName}_Internship_Certificate.doc`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function generateWordContent() {
            const studentName = document.getElementById('previewStudentName').textContent;
            const regNo = document.getElementById('previewRegNo').textContent;
            const startDate = document.getElementById('previewStartDate').textContent;
            const endDate = document.getElementById('previewEndDate').textContent;
            const academicYear = document.getElementById('previewAcademicYear').textContent;
            const issueDate = document.getElementById('previewIssueDate').textContent;
            const certNumber = document.getElementById('previewCertNumber').textContent;
            
            return `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">
<head>
<meta charset="utf-8">
<title>Internship Certificate</title>
<style>
body { 
    font-family: 'Times New Roman', serif; 
    font-size: 12pt; 
    line-height: 1.6; 
    margin: 1in;
    color: black;
}
.center { text-align: center; }
.bold { font-weight: bold; }
.title { 
    font-size: 16pt; 
    font-weight: bold; 
    text-transform: uppercase; 
    text-align: center;
    margin: 20pt 0; 
}
.student-name { 
    font-size: 14pt; 
    font-weight: bold; 
    text-align: center;
    margin: 15pt 0; 
    text-decoration: underline;
}
.details { margin: 15pt 0; }
.detail-item { margin: 5pt 0; }
.compliance { 
    text-align: center; 
    margin: 15pt 0; 
    font-weight: bold;
}
.signatures { 
    margin-top: 50pt; 
    text-align: center;
}
.signature-line { 
    display: inline-block;
    width: 200pt; 
    border-bottom: 1pt solid black; 
    margin: 30pt 50pt 5pt 50pt; 
}
.signature-title {
    display: inline-block;
    margin: 0 50pt;
    font-weight: bold;
}
</style>
</head>
<body>
<div class="title">INTERNSHIP COMPLETION CERTIFICATE</div>

<div class="compliance">✓ NCISM Compliant • 12-Month Compulsory Rotatory Internship • BAMS Program<br>
NCISM College Code: AYU0484 | RGUHS College Code: A456</div>

<div class="center">
<p>This is to certify that</p>

<div class="student-name">${studentName}</div>

<p>has successfully completed the mandatory <span class="bold">12-month Compulsory Rotatory Internship</span> as required under the regulations of the National Commission for Indian System of Medicine (NCISM) for the Bachelor of Ayurvedic Medicine and Surgery (BAMS) degree program.</p>
</div>

<div class="details">
<p class="bold">INTERNSHIP DETAILS:</p>
<div class="detail-item">• Registration Number: ${regNo}</div>
<div class="detail-item">• Internship Start Date: ${startDate}</div>
<div class="detail-item">• Internship Completion Date: ${endDate}</div>
<div class="detail-item">• Duration: 12 Months (365 Days)</div>
<div class="detail-item">• Academic Year: ${academicYear}</div>
<div class="detail-item">• NCISM College Code: AYU0484</div>
<div class="detail-item">• RGUHS College Code: A456</div>
</div>

<p>The internship was conducted in accordance with the NCISM regulations and included rotations in various departments of Ayurveda including Kayachikitsa, Panchakarma, Shalya Tantra, Shalakya Tantra, Prasuti Tantra & Stree Rog, and Kaumarbhritya, along with community health settings as mandated by the curriculum.</p>

<p>The candidate has demonstrated satisfactory performance and clinical competency during the internship period and is eligible for registration with the respective State Medical Council/Board.</p>

<p><span class="bold">Date of Issue:</span> ${issueDate} &nbsp;&nbsp;&nbsp; <span class="bold">Place:</span> Varur &nbsp;&nbsp;&nbsp; <span class="bold">Certificate No:</span> ${certNumber}</p>

<div class="signatures">
<div>
<div class="signature-line"></div>
<div class="signature-line"></div>
</div>
<div>
<span class="signature-title">Medical Superintendent</span>
<span class="signature-title">Dean/Principal</span>
</div>
</div>

</body>
</html>`;
        }

        // Bulk Download Functions
        function downloadAllPDFs() {
            if (studentsData.length === 0) {
                alert('No student data available');
                return;
            }
            
            alert('Generating PDFs for all students. This may take a few moments...');
            
            studentsData.forEach((student, index) => {
                setTimeout(() => {
                    populatePreview({
                        StudentName: student.StudentName,
                        RegistrationNo: student.RegistrationNo,
                        AcademicYear: student.AcademicYear,
                        StartDate: formatDate(student.StartDate),
                        EndDate: formatDate(student.EndDate),
                        IssueDate: formatDate(student.IssueDate),
                        CertNumber: student.CertNumber
                    });
                    
                    document.getElementById('certificatePreview').classList.remove('hidden');
                    
                    setTimeout(() => {
                        downloadPDF();
                    }, 500);
                }, index * 2000);
            });
        }

        function downloadAllWord() {
            if (studentsData.length === 0) {
                alert('No student data available');
                return;
            }
            
            alert('Generating Word documents for all students...');
            
            studentsData.forEach((student, index) => {
                setTimeout(() => {
                    populatePreview({
                        StudentName: student.StudentName,
                        RegistrationNo: student.RegistrationNo,
                        RollNumber: student.RollNumber,
                        AcademicYear: student.AcademicYear,
                        StartDate: formatDate(student.StartDate),
                        EndDate: formatDate(student.EndDate),
                        IssueDate: formatDate(student.IssueDate),
                        CertNumber: student.CertNumber
                    });
                    
                    setTimeout(() => {
                        downloadWord();
                    }, 500);
                }, index * 1000);
            });
        }

        function downloadSinglePDF(index) {
            const student = studentsData[index];
            populatePreview({
                StudentName: student.StudentName,
                RegistrationNo: student.RegistrationNo,
                AcademicYear: student.AcademicYear,
                StartDate: formatDate(student.StartDate),
                EndDate: formatDate(student.EndDate),
                IssueDate: formatDate(student.IssueDate),
                CertNumber: student.CertNumber
            });
            
            document.getElementById('certificatePreview').classList.remove('hidden');
            setTimeout(() => {
                downloadPDF();
            }, 500);
        }

        function downloadSingleWord(index) {
            const student = studentsData[index];
            populatePreview({
                StudentName: student.StudentName,
                RegistrationNo: student.RegistrationNo,
                AcademicYear: student.AcademicYear,
                StartDate: formatDate(student.StartDate),
                EndDate: formatDate(student.EndDate),
                IssueDate: formatDate(student.IssueDate),
                CertNumber: student.CertNumber
            });
            
            setTimeout(() => {
                downloadWord();
            }, 500);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB');
        }

        function saveData() {
            localStorage.setItem('certificateStudents', JSON.stringify(studentsData));
        }

        function downloadFile(content, filename, contentType) {
            const a = document.createElement('a');
            const file = new Blob([content], {type: contentType});
            a.href = URL.createObjectURL(file);
            a.download = filename;
            a.click();
        }
    </script>
</body>
</html>
